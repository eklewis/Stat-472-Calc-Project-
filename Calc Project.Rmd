---
title: "Stat 472 Calc Project"
author: "Emma, Jackson, Amanda, Megan"
date: "3/3/2020"
output: pdf_document
---

1. Data required for the Calculus retention study is in S1 File in the Supporting Information section of the paper. S2 File has information about the survey questions and response codings in the data set. Load the data and understand each column.


```{r echo=FALSE, message=FALSE}
#install.packages("dplyr")
#install.packages("tidyr")
#install.packages("knitr")
#install.packages("kableExtra")
#install.packages("forcats")

library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)
library(forcats)
```



```{r}
data <- read.csv("CSPCC_Switcher_Data.csv")
data$Q3FUS=paste(data$Q3FUS_No, data$Q3FUS_Yes)

```


# Switcher Coding

Switcher Groups

```{r}
s1 <- data %>% filter(Q26 == 1, Q3FUS_No == "No") %>% mutate(Switch = 1)
s2 <- data %>% filter(Q26 == 3, Q3FUS_No == "No") %>% mutate(Switch = 1)
s3 <- data %>% filter(is.na(Q26),Q5Post == 1, Q3FUS_No == "No") %>% mutate(Switch = 1)
s4 <- data %>% filter(is.na(Q26),Q5Post == 3, Q3FUS_No == "No") %>% mutate(Switch = 1)
s5 <- data %>% filter(Q26 == 1, Q3Post == 3, Q5Post == 1, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 1)
s6 <- data %>% filter(Q26 ==1, Q3Post == 2, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 1)
s7 <- data %>% filter(Q26 == 3, Q5Post == 1, Q3Post == 3, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 1)
s8 <- data %>% filter(Q26 == 3, Q3Post == 2, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 1)
s9 <- data %>% filter(is.na(Q26), Q5Post == 1, Q3Post ==3, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 1)
s10 <- data %>% filter(is.na(Q26), Q5Post ==1, Q3Post ==2, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 1)
s11 <- data %>% filter(is.na(Q26), Q5Post == 3, Q3Post ==2, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 1)
```


Persister Groups

```{r}
p12 <- data %>% filter(Q26 == 1, Q3FUS_Yes == "Yes") %>% mutate(Switch = 0)

p13 <- data %>% filter(Q26 == 3, Q3FUS_Yes == "Yes") %>% mutate(Switch = 0)

p14 <- data %>% filter(is.na(Q26), Q5Post == 1, Q3FUS_Yes == "Yes") %>% mutate(Switch = 0)

p15 <- data %>% filter(is.na(Q26), Q5Post == 3, Q3FUS_Yes == "Yes") %>% mutate(Switch = 0)

p16 <- data %>% filter(Q26 == 1, Q3Post == 1, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 0)

p17 <- data %>% filter(Q26 == 1, Q5Post == 3, Q3Post == 3, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 0)

p18 <- data %>% filter(Q26 == 1, Q5Post == 2, Q3Post == 3, Q3FUS_No != "No", Q3FUS_Yes != "Yes" ) %>% mutate(Switch = 0)

p19 <- data %>% filter(Q26 == 1, is.na(Q5Post), Q3Post == 3, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 0)

p20 <- data %>% filter(Q26 == 3, Q3Post == 1, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 0)
p21 <- data %>% filter(Q26 == 3, Q5Post == 3, Q3Post == 3, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 0)


p22 <- data %>% filter(Q26 == 3, Q5Post == 2, Q3Post == 3, Q3FUS_No != "No", Q3FUS_Yes != "Yes")  %>% mutate(Switch = 0)

p23 <- data %>% filter(Q26 == 3, is.na(Q5Post), Q3Post == 3, Q3FUS_No != "No", Q3FUS_Yes != "Yes" )  %>% mutate(Switch = 0)

p24 <- data %>% filter(is.na(Q26), Q5Post == 1, Q3Post == 1, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 0)

p25 <- data %>% filter(is.na(Q26), Q5Post == 3, Q3Post == 1, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 0)

p26 <- data %>% filter(is.na(Q26), Q5Post == 3, Q3Post == 3, Q3FUS_No != "No", Q3FUS_Yes != "Yes") %>% mutate(Switch = 0)


```

```{r}

switchdata <- rbind(s1,s2,s3,s4,s5,s6,s7,s8,s9,s10,
                    s11,p12,p13,p14,p15,p16,p17,p18,
                    p19,p20,p21,p22,p23,p24,p25,p26)

```

2. Prepare the data for analysis using S3 File. You should be left with 2,266 students (rows) after data preparation.

```{r}
careerdata <- switchdata %>% 
  mutate(major = fct_collapse(factor(switchdata$Q60, levels=1:16), 
                              `1` = c("3","4","5","7","8","9"), 
                              `2` = "6", 
                              `3` = c("1","2"),
                              `4` = c("10","11","12","13","14","15"),
                              `5` = "16")) %>%
  
 filter(!(is.na(Q15_CalculusNonAPFinalGrade) & is.na(Q17_CalculusABFinalGrade) 
          & is.na(Q17_CalculusBCFinalGrade) & is.na(Q18))) %>% #filter cal exp
  
  filter(! is.na(major)) %>% #filter major
  
  filter(! (is.na(Q3_SATMath) & is.na(Q7_ACTMath))) %>% #filter no stnd test
  
  
  filter(Q3_SATMath %in% seq(200,800,10) | Q7_ACTMath %in% seq(1,36,1)) %>%
  
  filter(! is.na(Q48)) %>%#filter gender
  
  filter(! (is.na(Q18Post_Applications) & is.na(Q18Post_Appointments) & is.na(Q18Post_AskedQs)
            & is.na(Q18Post_Discouraged) & is.na(Q18Post_Explanations) &
              is.na(Q18Post_Listened) &         is.na(Q18Post_ProblemSolver) &
              is.na(Q18Post_Time))) %>% #filer instruc qual
  
filter(! (is.na(Q19Post_SpecificProblems) & is.na(Q19Post_WorkTogether) &
            is.na(Q19Post_Discussion) & is.na(Q19Post_Presentations) &
            is.na(Q19Post_Individually) & is.na(Q19Post_Lecture) & is.na(Q19Post_AskQuestions)
          & is.na(Q19Post_ExplainThinking))) #filter student prep
  

#unique(careerdata$Q3_SATMath)

```


```{r}
## Instructor Quality 
IQ <- select(data, Q18Post_Applications, Q18Post_Appointments, Q18Post_AskedQs, Q18Post_Discouraged, Q18Post_Explanations, Q18Post_Listened, Q18Post_ProblemSolver, Q18Post_Time)

IQ$Q18Post_Discouraged <- 7-IQ$Q18Post_Discouraged

IQ <- na.omit(IQ)

pr_IQ <- princomp(IQ)

rescale_load_iq <- pr_IQ$loadings/sum(pr_IQ$loadings[,1])

round(rescale_load_iq[,1],3)

IQ <- IQ %>% mutate(Inst.Qual = (rescale_load_iq[,1]*(Q18Post_Applications+ Q18Post_Appointments+ Q18Post_AskedQs+ Q18Post_Discouraged+ Q18Post_Explanations+ Q18Post_Listened+ Q18Post_ProblemSolver+ Q18Post_Time))) 

```

```{r}
## Student centered
SC <- select(data, Q19Post_AskQuestions, Q19Post_Discussion, Q19Post_ExplainThinking, Q19Post_Individually, Q19Post_Lecture,Q19Post_Presentations,Q19Post_SpecificProblems, Q19Post_WorkTogether)

SC$Q19Post_Lecture <- 7 - SC$Q19Post_Lecture

SC <- na.omit(SC)

pr_SC <- princomp(SC)

round(pr_SC$loadings[,1],3)

rescale_load_sc <- pr_SC$loadings/sum(pr_SC$loadings[,1])

round(rescale_load_sc[,1],3)


SC <- SC %>% mutate(Student.Cent = (rescale_load_sc[,1]*(Q19Post_AskQuestions + Q19Post_Discussion + Q19Post_ExplainThinking + Q19Post_Individually + Q19Post_Lecture + Q19Post_Presentations + Q19Post_SpecificProblems + Q19Post_WorkTogether)))
```

```{r}
#Make variables for Instructor quality and student centered practices
careerdata <- careerdata %>% 
  mutate(Inst.Qual = (rescale_load_iq[,1]*(Q18Post_Applications+ Q18Post_Appointments+
                                             Q18Post_AskedQs+ Q18Post_Discouraged+
                                             Q18Post_Explanations+ Q18Post_Listened+ 
                                             Q18Post_ProblemSolver+ Q18Post_Time))) %>% 
  mutate(Student.Cent = (rescale_load_sc[,1]*(Q19Post_AskQuestions + Q19Post_Discussion +
                                              Q19Post_ExplainThinking+Q19Post_Individually
                                              +Q19Post_Lecture + Q19Post_Presentations +
                                          Q19Post_SpecificProblems+Q19Post_WorkTogether)))

##Make vairables for High school, college, and no experience
###CURRENTLY NOT CORRECT 
try <- careerdata %>% mutate(HighSchoolExp = as.numeric(I(Q15_CalculusNonAPFinalGrade %in% seq(1,12,1) | Q17_CalculusABFinalGrade %in% seq(1,12,1) | Q17_CalculusBCFinalGrade %in% seq(1,12,1)))) %>% mutate(CollegeExp = I(Q18 == 1)) %>% 
  mutate(NoExp = I(is.na(Q15_CalculusNonAPFinalGrade) & 
                     is.na(Q17_CalculusABFinalGrade) & 
                     is.na(Q17_CalculusBCFinalGrade) & 
                     is.na(Q18)))

```

3. Reproduce the tables S1, S5, S6, S7, and S8.
Caution: There could be a typo in table S1.

Table s1:

```{r}
x1=c("1", "2", "3", "4", "5", "6","7", "8", "9", "10", "11")
x2=c(count(s1), count(s2), count(s3), count(s4), count(s5), count(s6), count(s7), count(s8), count(s9), count(s10), count(s11))

x3 <- c("Y","M","NA","NA","Y","Y","M","M","NA","NA","NA")
x4 <- c("","","Y","M","Y","","Y","","Y","Y","M")
x5 <- c("","","","","M","N","M","N","M","N","N")
x6 <- c("N","N","N","N","NA","NA","NA","NA","NA","NA","NA")



tabS1 <- cbind(x1,x2,x3,x4,x5,x6)

colnames(tabS1) <- c("Switcher Group", "Number of Students","Beginning of term","End of term; reflect", "End of term", "Follow Up")
rownames(tabS1) <- NULL

kable(tabS1) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```

Table s1 (persister group)

```{r}
y1=c("12", "13", "14", "15", "16", "17", "18", 
     "19", "20", "21", "22", "23", "24", "25", "26")
y2=c(count(p12), count(p13), count(p14), count(p15), count(p16), 
     count(p17), count(p18), count(p19), count(p20), count(p21), 
     count(p22), count(p23), count(p24), count(p25), count(p26))
y3=c("Y", "M", "NA", "NA", "Y", "Y", "Y", "Y", "M", "M", "M", "M", "NA", "NA", "NA")
y4=c("", "", "Y", "M", "", "M", "N", "NA", "", "M", "N", "NA", "Y", "M", "M")
y5=c("", "", "", "", "Y", "M", "M", "M", "Y", "M", "M", "M", "Y", "Y", "M")
y6=c("Y", "Y", "Y", "Y", "NA", "NA", "NA", "NA", "NA", "NA", "NA", "NA", "NA", "NA", "NA")

s1_p=cbind(y1, y2, y3, y4, y5, y6)

colnames(s1_p) <- c("Persister Group", "Number of Students","Beginning of term","End of term; reflect", "End of term", "Follow Up")
rownames(s1_p) <- NULL

kable(s1_p)%>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

Table S5 (Percentage of students that switch out of calculus by career choice and gender)

```{r}
##S5
s5 <- careerdata %>% group_by(major, Q48) %>% summarise(N = length(Q18), Switcher = round((length(which(Switch == '1'))/length(Q18))*100,1))
colnames(s5) <- c('Major', 'Gender', 'N', 'Switcher %')
s5$Major <- c("Pre-Med", "Pre-Med", "STEM", "STEM", "Engineering", "Engineering", "Non-STEM", "Non-STEM", "Undecided", "Undecided")
s5$Gender <- rep(c("Male", "Female"), 5)

kable(s5) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

S6 (Amanda)

```{r}

```

S8 (Jackson/Megan)

```{r}

```

S7 (Emma)

```{r}

```

